import React, { useEffect, useState } from "react";
import { useLocation, useParams } from "react-router-dom";

import { cookie, getCookie } from "../util/Cookie";
import "./video.css";
import axios from "axios";
import { Button } from "bootstrap";
import { useSelector } from "react-redux";
import ChatGpt from './../util/ChatGpt';

function Video(props) {
  let { id } = useParams();
  const [userComment, setUser] = useState([]);
  const token = getCookie("access_token");
  const [modalTitle, setModalTitle] = useState(""); // modalÏ†úÎ™©
  const [modalContent, setModalContent] = useState([]); // modal
  const [isModalOpen, setIsModalOpen] = useState(false); //modalÏ∞Ω ÎùÑÏö∞Í∏∞
  const [selectedCommentIndex, setSelectedCommentIndex] = useState();

  const handleCloseModal = () => {
    setIsModalOpen(false);
  };

  const [createComment, setCreateComment] = useState(""); // ÎåÄÎåìÍ∏Ä Î≠êÎùºÍ≥† Ïì∏ÏßÄ
  const [createCommentId, setCreateCommentId] = useState(""); // ÎåìÍ∏ÄÏùò id Í∞ÄÏ†∏Ïò§Í∏∞
  const [commentLength, setCommentLength] = useState([]); // ÎåìÍ∏Ä Í∞ØÏàò state
  const [recommentLength, setRecommentLength] = useState([]);

  useEffect(() => {
    getComments();
  }, []);

  const getComments = async () => {
    //ÎåìÍ∏ÄÎì§Î∂àÎü¨Ïò§Í∏∞
    try {
      const response = await axios.post(
        `${process.env.REACT_APP_URL}/api/get-comment-list/`,
        {
          id: id,
        },
        {
          headers: { Authorization: token },
        }
      );
      const commentdatas = response.data.items.map(
        (item) => item.snippet.topLevelComment
      );
      setUser(commentdatas);
    } catch (error) {}
  };
  const addComment = async () => {
    // ÎãµÍ∏Ä Îã¨Í∏∞
    try {
      const comment_response = await axios.post(
        `${process.env.REACT_APP_URL}/api/post-comment-insert/`,
        {
          parentId: createCommentId,
          textOriginal: createComment,
        },
        {
          headers: { Authorization: token },
        }
      );
      let copy = [...modalContent];
      copy.unshift(comment_response.data);
      setModalContent(copy);
    } catch (error) {
      console.log(error);
    }
  };

  const removeComment = async (removeId, i) => {
    //ÎãµÍ∏ÄÏÇ≠Ï†ú
    try {
      const remove_response = await axios.post(
        `${process.env.REACT_APP_URL}/api/post-comment-delete/`,
        {
          comment_id: removeId,
        },
        {
          headers: { Authorization: token },
        }
      );
      let copy = [...modalContent];
      copy.splice(i, 1);
      setModalContent(copy);
    } catch (error) {
      console.log(error);
    }
  };

  const handleCommentClick = async (comment, index) => {
    setModalTitle(comment);
    setIsModalOpen(true);
    setSelectedCommentIndex(index);
    await getRecomment(comment.id);
  };

  useEffect(() => {
    getRecomment();
  }, [modalTitle]);
  const getRecomment = async (parentId) => {
    // ÎãµÍ∏ÄÎì§ Î∂àÎü¨Ïò§Í∏∞
    try {
      const get_Recomment = await axios.post(
        `${process.env.REACT_APP_URL}/api/get-recomment-list/`,
        {
          parentId: parentId, //ÎåìÍ∏Ä id
        },
        {
          headers: { Authorization: token },
        }
      );
      const recommentdatas = get_Recomment.data.items.map((item) => item);

      setModalContent(recommentdatas);
      let copy = [...recommentLength]; // Í∞ÄÏÉÅÏùò state ÏÉùÏÑ±

      recommentdatas.map((a, i) => {
        // Î∂àÎü¨Ïò® ÎãµÍ∏ÄÏùò Í∏∏Ïù¥ÎßåÌÅº copy ÏïàÏóê falseÎ°ú Ï±ÑÏõåÏ§ÄÎã§.
        copy.push(false); // ÏòàÎ•º Îì§Ïñ¥ Î∂àÎü¨Ïò® ÎãµÍ∏ÄÏùò Í∞ØÏàòÍ∞Ä 2Í∞úÎùºÎ©¥ copy ÏïàÏóêÎäî [false,false]
      });
      setRecommentLength(copy); // copyÎ•º ÎãµÍ∏ÄÏùò Í∏∏Ïù¥ state ÏïàÏóê ÎÑ£Ïñ¥Ï§ÄÎã§.
    } catch (error) {
      console.log(error);
    }
  };

  let state = useSelector((state) => {
    return state;
  });
  const retrievedTitle = localStorage.getItem("videoTitle");

  return (
    <div className="video_page">
      <div className="video_containor">
        <div className="video_title">
          <h3>{retrievedTitle}</h3>
        </div>
        <div>
          {userComment.map((a, i) => {
            return (
              <div
                key={i}
                onClick={() => handleCommentClick(a, i)}
                className="video_comment_list"
              >
                <h2 className="video_comment_user">
                  {userComment[i].snippet.authorDisplayName}
                </h2>
                <div className="video_comment_block">
                  <h3 className="video_comment_content">
                    {userComment[i].snippet.textDisplay}
                  </h3>
                  <p className="video_comment_like">
                    üëç {userComment[i].snippet.likeCount}
                  </p>
                  <p className="video_comment_update">
                    {calculateElapsedTime(userComment[i].snippet.updatedAt)}
                  </p>
                </div>

                {isModalOpen && i == selectedCommentIndex && (
                  <div>
                    <div id="myModal" className="video_popup">
                      <div className="video_popup-content">
                        {/* <span
                            className="video_close"
                            onClick={() => {
                              handleCloseModal();
                              let box = [];
                              setModalContent([...box]);
                            }}
                          >
                            &times;
                          </span> */}

                        <div className="video_modal_form">
                          <input
                            type="text"
                            onChange={(e) => {
                              setCreateComment(e.target.value);
                              setCreateCommentId(modalTitle.id);
                            }}
                          />
                          <label className="video_input_label">
                            ÎåìÍ∏ÄÏ∂îÍ∞Ä..
                          </label>
                          <span className="video_input_span"></span>
                          <button
                            onClick={() => {
                              addComment();
                            }}
                          >
                            ÎåìÍ∏Ä
                          </button>
                        </div>
                        {modalContent.map((a, i) => (
                          <div className="video_modal_content" key={i}>
                            <img
                              className="video_recomment_img"
                              src={
                                modalContent[i].snippet.authorProfileImageUrl
                              }
                            />
                            <div className="video_recomment_main">
                              <div className="video_recomment_head">
                                <div className="video_recomment_username">
                                  {modalContent[i].snippet.authorDisplayName}
                                </div>
                                <div className="video_recomment_update">
                                  {calculateElapsedTime(
                                    modalContent[i].snippet.updatedAt
                                  )}
                                </div>
                              </div>

                              <div className="video_recomment_text">
                                {modalContent[i].snippet.textOriginal}
                              </div>
                              <div className="video_recomment_bottom">
                                <div className="video_recomment_like">
                                  üëç {modalContent[i].snippet.likeCount}
                                </div>
                                <span
                                  onClick={(e) => {
                                    e.stopPropagation(); //Ïù¥Î≤§Ìä∏Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
                                    let copy = [...recommentLength]; // Í∞ÄÏÉÅÏùò state ÏÉùÏÑ±
                                    copy[i] = true; // ÏòàÎ•º Îì§Ïñ¥ ÎãµÍ∏ÄÏù¥ 2Í∞úÏù∏ Ï∞ΩÏóêÏÑú [false,false]
                                    setRecommentLength(copy); // Ïù∏Îç±Ïä§Í∞íÏóê ÎßûÎäîÍ≤ÉÏùÑ trueÎ°ú ÎßåÎì§Ïñ¥Ï§å [false,true]
                                  }}
                                >
                                  ÎãµÍ∏Ä
                                </span>
                              </div>
                              {recommentLength[i] == true ? ( // Ïù∏Îç±Ïä§Í∞íÏóê ÎßûÎäî Í∞íÏù¥ true Ï†Ä Î∞ëÏóê ÏΩîÎìúÎ•º Î≥¥Ïó¨Ï§òÎùº
                                <div className="video_add_recomment">
                                  <input
                                    className="video_recomment_input"
                                    onChange={(e) => {
                                      setCreateComment(
                                        "@" +
                                          modalContent[i].snippet
                                            .authorDisplayName +
                                          e.target.value
                                      );
                                      setCreateCommentId(modalTitle.id);
                                    }}
                                  />
                                  <label className="video_recomment_label">
                                    ÎãµÍ∏ÄÏ∂îÍ∞Ä..
                                  </label>
                                  <span className="video_recommentinput_span"></span>
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation(); //Ïù¥Î≤§Ìä∏Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
                                      let copy = [...recommentLength];
                                      copy[i] = false;
                                      setRecommentLength(copy);
                                    }}
                                  >
                                    Ï∑®ÏÜå
                                  </button>
                                  <button
                                    onClick={(e) => {
                                      addComment();
                                      e.stopPropagation(); //Ïù¥Î≤§Ìä∏Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
                                      let copy = [...recommentLength];
                                      copy[i] = false;
                                      setRecommentLength(copy);
                                    }}
                                  >
                                    ÎãµÍ∏Ä
                                  </button>
                                  <button onClick={() => {
                                    ChatGpt(modalContent[i].snippet.textOriginal);
                                    ;
                                  }}>GPT</button>
                                </div>
                              ) : null}
                            </div>

                            <span
                              className="video_recomment_remove"
                              onClick={() => {
                                removeComment(modalContent[i].id, i);
                              }}
                            >
                              ÏÇ≠Ï†ú
                            </span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

function calculateElapsedTime(updatedAt) {
  const ONE_MINUTE_IN_MILLISECONDS = 60 * 1000; // 1Î∂ÑÏùÑ Î∞ÄÎ¶¨Ï¥àÎ°ú Í≥ÑÏÇ∞
  const ONE_HOUR_IN_MILLISECONDS = 60 * ONE_MINUTE_IN_MILLISECONDS; // 1ÏãúÍ∞ÑÏùÑ Î∞ÄÎ¶¨Ï¥àÎ°ú Í≥ÑÏÇ∞
  const ONE_DAY_IN_MILLISECONDS = 24 * ONE_HOUR_IN_MILLISECONDS; // 1ÏùºÏùÑ Î∞ÄÎ¶¨Ï¥àÎ°ú Í≥ÑÏÇ∞
  const ONE_MONTH_IN_MILLISECONDS = 30 * ONE_DAY_IN_MILLISECONDS; // 1Îã¨ÏùÑ Î∞ÄÎ¶¨Ï¥àÎ°ú Í≥ÑÏÇ∞

  const currentTimestamp = new Date().getTime(); // ÌòÑÏû¨ ÏãúÍ∞ÑÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Íµ¨Ìï®
  const updatedAtTimestamp = new Date(updatedAt).getTime(); // ÏóÖÎç∞Ïù¥Ìä∏Îêú ÏãúÍ∞ÑÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Íµ¨Ìï®

  const elapsedTimestamp = currentTimestamp - updatedAtTimestamp; // ÏóÖÎç∞Ïù¥Ìä∏Îêú ÏãúÍ∞ÑÍ≥º ÌòÑÏû¨ ÏãúÍ∞ÑÏùò Ï∞®Ïù¥Î•º Íµ¨Ìï®

  if (elapsedTimestamp < ONE_HOUR_IN_MILLISECONDS) {
    const elapsedMinutes = Math.floor(
      elapsedTimestamp / ONE_MINUTE_IN_MILLISECONDS
    );
    return `${elapsedMinutes}Î∂Ñ Ï†Ñ`;
  } else if (elapsedTimestamp < ONE_DAY_IN_MILLISECONDS) {
    const elapsedHours = Math.floor(
      elapsedTimestamp / ONE_HOUR_IN_MILLISECONDS
    );
    return `${elapsedHours}ÏãúÍ∞Ñ Ï†Ñ`;
  } else if (elapsedTimestamp < ONE_MONTH_IN_MILLISECONDS) {
    const elapsedDays = Math.floor(elapsedTimestamp / ONE_DAY_IN_MILLISECONDS);
    return `${elapsedDays}Ïùº Ï†Ñ`;
  } else {
    const elapsedMonths = Math.floor(
      elapsedTimestamp / ONE_MONTH_IN_MILLISECONDS
    );
    return `${elapsedMonths}Í∞úÏõî Ï†Ñ`;
  }
}

export default Video;
